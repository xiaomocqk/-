/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
define(["GlobalUtils","PageInfo","ContentPreview","Promotion"],function(a,b,c,d){function e(a){Y&&(Y.getElement()&&Y.getElement().parentNode&&Y.getElement().parentNode.removeChild(Y.getElement()),a&&Y.destroy()),a&&(Y=null),document.documentElement.classList.remove("skitchWaiting","skitchReady")}function f(a){!V.classList.contains("evernoteClipperVisible")||document.documentElement.classList.contains("evernoteOptionsOpen")?(V.classList.remove("evernoteClipperVisible"),w()):(V.addEventListener("webkitTransitionEnd",w),V.classList.remove("evernoteClipperVisible")),W&&W.parentNode&&(W.parentNode.removeChild(W),W=null),document.documentElement.classList.remove("evernoteOptionsOpen"),c.clear(),e(a.notClipping),a.notClipping&&(c.reset(),c.clearHighlights()),window.removeEventListener("keydown",y),window.removeEventListener("keypress",z),window.removeEventListener("mousedown",A),window.removeEventListener("unload",B),Browser.sendToExtension({name:"showLoggedInOrOutState"})}function g(a){"function"==typeof ba[a.keycode]&&ba[a.keycode](a.keycode,null,!0)}function h(){document.documentElement.classList.add("skitchWaiting")}function i(a,b,c){document.documentElement.classList.contains("evernoteOptionsOpen")?n({authed:!0}):V.classList.contains("evernoteClipperVisible")&&(c?f({notClipping:!0}):Browser.sendToExtension({name:"bounce",message:{name:"gt_handleEscape",keycode:a}}))}function j(a){V.classList.contains("evernoteClipperVisible")&&!document.documentElement.classList.contains("skitchReady")&&("notebook"===a?Browser.sendToExtension({name:"bounce",message:{name:"gt_openNotebook"}}):"tags"===a&&Browser.sendToExtension({name:"bounce",message:{name:"gt_openTags"}}))}function k(a){V.classList.contains("evernoteClipperVisible")&&!document.documentElement.classList.contains("skitchReady")&&("expand"==a?c.expandPreview():"contract"==a?c.contractPreview():"up"==a?c.moveToElementAbove():"down"==a&&c.moveToElementBelow())}function l(a,b){aa&&ba[a]&&ba[a](a,b)}function m(a,b){ba[a]&&ba[a](a,b)}function n(a){a.authed?(Browser.sendToExtension({name:"bounce",message:{name:"gt_reactivateClipperTool"}}),W&&W.parentNode&&(W.parentNode.removeChild(W),W=null),document.documentElement.classList.remove("evernoteOptionsOpen")):f({notClipping:!0})}function o(){Browser.sendToExtension({name:"getKeyboardShortcuts",shortcuts:["startWebClipperShortcut"]}),V=document.createElement("iframe"),V.id="evernoteGlobalTools",V.addEventListener("load",function(){Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",handlers:ca,enabled:aa}}),C()}),V.src=Browser.extension.getURL("content/global_tools/global_tools.html")}function p(){I(),document.documentElement.appendChild(V),window.addEventListener("keydown",y),window.addEventListener("keypress",z),window.addEventListener("mousedown",A),window.addEventListener("unload",B),Browser.sendToExtension({name:"getKeyboardShortcuts",shortcuts:["closeWebClipperShortcut","previewArticleShortcut","previewFullPageShortcut","previewUrlShortcut","selectionModeShortcut","takeScreenshotShortcut","clearlyShortcut","pdfShortcut","emailShortcut","expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut","selectNotebookShortcut","addTagsShortcut","saveShortcut","arrowShortcut","textShortcut","rectangleShortcut","roundedRectangleShortcut","ellipseShortcut","lineShortcut","markerShortcut","highlighterShortcut","stampShortcut","pixelateShortcut","cropShortcut"]}),ea++}function q(){V&&V.classList.contains("evernoteClipperVisible")&&Browser.sendToExtension({name:"showOpenState"})}function r(a){aa=a.keyboardShortcutsEnabled;var b={};for(var c in a.keys){var d=a.keys[c].split("|"),e=d.join(" + ");if(b[e]=l,ca[c]=[e],"startWebClipperShortcut"==c?ba[e]=O:"closeWebClipperShortcut"==c?(b[e]=m,ba[e]=i,da[c]=[e]):"previewArticleShortcut"==c?ba[e]=function(){M("article")}:"previewFullPageShortcut"==c?ba[e]=function(){M("fullPage")}:"previewUrlShortcut"==c?ba[e]=function(){M("url")}:"selectionModeShortcut"==c?ba[e]=function(){M("selection")}:"takeScreenshotShortcut"==c?ba[e]=function(){M("screenshot")}:"clearlyShortcut"==c?ba[e]=function(){M("clearly")}:"pdfShortcut"==c?ba[e]=function(){M("pdf")}:"emailShortcut"==c?ba[e]=function(){M("email")}:"expandArticleShortcut"==c?(b[e]=m,ba[e]=function(){k("expand")}):"contractArticleShortcut"==c?(b[e]=m,ba[e]=function(){k("contract")}):"moveArticleUpShortcut"==c?(b[e]=m,ba[e]=function(){k("up")}):"moveArticleDownShortcut"==c?(b[e]=m,ba[e]=function(){k("down")}):"selectNotebookShortcut"==c?ba[e]=function(){j("notebook")}:"addTagsShortcut"==c?ba[e]=function(){j("tags")}:"saveShortcut"==c?ba[e]=E:"arrowShortcut"==c?ba[e]=function(){N("shapes","arrow")}:"textShortcut"==c?ba[e]=function(){N("text")}:"rectangleShortcut"==c?ba[e]=function(){N("shapes","rectangle")}:"roundedRectangleShortcut"==c?ba[e]=function(){N("shapes","roundedRectangle")}:"ellipseShortcut"==c?ba[e]=function(){N("shapes","ellipse")}:"lineShortcut"==c?ba[e]=function(){N("shapes","line")}:"markerShortcut"==c?ba[e]=function(){N("marker")}:"highlighterShortcut"==c?ba[e]=function(){N("highlighter")}:"stampShortcut"==c?ba[e]=function(){N("stamps")}:"pixelateShortcut"==c?ba[e]=function(){N("pixelate")}:"cropShortcut"==c&&(ba[e]=function(){N("crop")}),d.indexOf("91")>-1){var f=JSON.parse(JSON.stringify(d));/windows/i.test(window.navigator.userAgent)?(f[d.indexOf("91")]="17",f.sort(function(a,b){return a-b}),ba[f.join(" + ")]=ba[e],delete ba[e],b[f.join(" + ")]=b[e],delete b[e],ca[c]&&(ca[c][0]=f.join(" + ")),da[c]&&(da[c][0]=f.join(" + "))):(f[d.indexOf("91")]="93",f.sort(function(a,b){return a-b}),ba[f.join(" + ")]=ba[e],b[f.join(" + ")]=b[e],ca[c]&&ca[c].push(f.join(" + ")),da[c]&&da[c].push(f.join(" + ")))}}Browser.addKeyboardHandlers(b),V&&V.parentNode&&Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",handlers:ca,enabled:aa}})}function s(a){aa=a.keyboardShortcutsEnabled,Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",enabled:aa}}),Browser.sendToExtension({name:"bounce",message:{name:"op_setKeyboardHandlers",enabled:aa}})}function t(a){Y=Markup({allowZoom:!1,container:document.body,document:a.data,margin:0,enableToolbar:!1,fullScreen:!0,success:function(){document.documentElement.classList.add("skitchReady"),Y.toast(Browser.i18n.getMessage("screenshotToast")),Browser.sendToExtension({name:"bounce",message:{name:"skitchSurfaceReady"}})}}),Y.on("toolStarted",function(a){Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:a})}),Y.on("toolStopped",function(a){"crop"===a&&V.style.removeProperty("display")}),Y.localize({CROP_APPLY_TEXT:Browser.i18n.getMessage("apply"),CROP_CANCEL_TEXT:Browser.i18n.getMessage("regForm_cancel"),MARKUP_STAMP_APPROVED_TEXT:Browser.i18n.getMessage("approved"),MARKUP_STAMP_EXCLAIM_TEXT:Browser.i18n.getMessage("wow"),MARKUP_STAMP_PERFECT_TEXT:Browser.i18n.getMessage("perfect"),MARKUP_STAMP_QUESTION_TEXT:Browser.i18n.getMessage("what"),MARKUP_STAMP_REJECTED_TEXT:Browser.i18n.getMessage("rejected"),ZOOM_RESET_TEXT:Browser.i18n.getMessage("reset"),ZOOM_TIP_TEXT:Browser.i18n.getMessage("panInstruction")})}function u(a,b,c){return P()?(D(),V.classList.contains("evernoteClipperVisible")?f({notClipping:!0}):(clipResultCoordinator.hideClipResult(!1),H(a)),void c()):(fa=[a,b,c],document.getElementById("evernoteLoading")||p(),void c())}function v(a){"string"==typeof a.oldShortcut&&(a.oldShortcut=[a.oldShortcut],a.shortcut=[a.shortcut],a.shortcutName=[a.shortcutName]);for(var b=0;b<a.oldShortcut.length;b++){var c=a.oldShortcut[b].split("|").join(" + "),d=a.shortcut[b].split("|").join(" + ");ba[d]=ba[c],delete ba[c];var e={};e[d]=["closeWebClipperShortcut","expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut"].indexOf(a.shortcutName[b])>-1?m:l,Browser.addKeyboardHandlers(e)}}function w(){V&&(V.removeEventListener("webkitTransitionEnd",w),V.parentNode&&V.parentNode.removeChild(V)),ea=0}function x(a){"opacity"===a.propertyName&&(Browser.sendToExtension({name:"getOption",option:"defaultClipAction"}),V.removeEventListener("webkitTransitionEnd",x))}function y(a){/Mac OS X/.test(window.navigator.userAgent)?a.metaKey&&a.preventDefault():/Windows/.test(window.navigator.userAgent)&&a.ctrlKey&&a.preventDefault(),[8,13,27,39,37,65,70,66,83,77,80,69,67].indexOf(a.keyCode)>-1?document.documentElement.classList.contains("skitchReady")||document.documentElement.classList.contains("skitchWaiting")||a.preventDefault():9===a.keyCode&&V.focus()}function z(a){if(document.documentElement.classList.contains("skitchReady")&&!document.querySelector("textarea.skitch-tool-element-text-editor")){var b=Y.getElement().offsetWidth/2,c=Y.getElement().offsetHeight/2;Browser.sendToExtension({name:"bounce",message:{name:"gt_useSkitchTool",tool:"text",loc:{x:b,y:c},charCode:a.charCode}}),a.preventDefault()}}function A(a){V.classList.contains("evernoteClipperVisible")?a.srcElement!==document.documentElement&&c.isPointOnVeil(a.pageX,a.pageY)&&a.preventDefault():document.documentElement.classList.contains("evernoteOptionsOpen")&&a.preventDefault()}function B(){Browser.sendToExtension({name:"showLoggedInOrOutState"})}function C(){ea++,fa.length>0&&P()&&(u(fa[0],fa[1],fa[2]),fa=[]),window.focus()}function D(){X&&X.parentNode&&X.parentNode.removeChild(X)}function E(){V.classList.contains("evernoteClipperVisible")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_save"}})}function F(a){V.style.setProperty("height",a.height+"px","important")}function G(a){a.height>window.innerHeight?(W.style.setProperty("height",window.innerHeight+"px","important"),W.style.setProperty("top","-webkit-calc(50% - "+window.innerHeight/2+"px)","important"),Browser.sendToExtension({name:"bounce",message:{name:"op_setPinchHeight",totalHeight:window.innerHeight}})):(W.style.setProperty("height",a.height+"px","important"),W.style.setProperty("top","-webkit-calc(50% - "+a.height/2+"px)","important"))}function H(a){if(a){Browser.sendToExtension({name:"main_recordActivity"}),$=a.bizUser,_=a.bizComplete,Browser.sendToExtension({name:"bounce",message:{name:"gt_initialize",ssoRequired:$&&!_,title:b.getTitle()}});var e=b.isCustomFormat();Browser.sendToExtension({name:"bounce",message:{name:"gt_setPossibleClipTypes",pageInfo:{pdf:b.getPdfUrl(),documentIsFrameset:b.documentIsFrameset,selection:b.getSelection()?!0:!1,gmail:b.isGmail(),gmailThread:b.isGmailThread(),custom:e?b.getCustomFormatSiteName(e.id):null}}}),Z=UUID.generateGuid(),Browser.sendToExtension({name:"getSmartFilingInfo",recText:b.getRecommendationText(!1),pendingNoteKey:Z,url:b.getUrl()}),a.selectedElement&&c.setElement(d.selectedElement)}V.addEventListener("webkitTransitionEnd",x),V.classList.add("evernoteClipperVisible"),Browser.sendToExtension({name:"showOpenState"}),Browser.sendToExtension({name:"bounce",message:{name:"ttc_close",which:"gmailTooltip"}}),Browser.sendToExtension({name:"bounce",message:{name:"ttc_close",which:"pdfTooltip"}}),Browser.sendToExtension({name:"bounce",message:{name:"ttc_close",which:"customTooltip"}})}function I(){X=document.createElement("div"),X.id="evernoteLoading",document.body.appendChild(X)}function J(){W||(W=document.createElement("iframe"),W.id="evernoteOptionsPage",W.addEventListener("load",function(){Browser.sendToExtension({name:"bounce",message:{name:"op_setKeyboardHandlers",handlers:da,enabled:aa}})}),W.src=Browser.extension.getURL("options.html#iframe")),document.documentElement.appendChild(W),document.documentElement.classList.add("evernoteOptionsOpen"),c.gray(),W.focus()}function K(){new TooltipCoordinator(Browser.extension.getURL("content/tooltips/tooltip.html#authed=true&which=ssoInProgress"),"ssoInProgress","evernoteSSOProgress")}function L(d){function e(a,b){"screenshot"===d.clipType?d.screenshotUrl?a():Y.getFile(function(b){Y.destroy(),Y=null,a({bytes:b.bytes,byteLength:b.bytes.byteLength})}):"clearly"===d.clipType?clipper.clipClearly(a,b):"article"===d.clipType?clipper.clipArticle(!0,a,b):"fullPage"===d.clipType?clipper.clipFullPage(!0,a,b):"selection"===d.clipType?clipper.clipSelection(!0,d.selectionText,a,b):"url"===d.clipType?clipper.clipUrl(a):"pdf"===d.clipType?clipper.clipPdf(a):"email"===d.clipType?clipper.clipEmail(a,b):"image"===d.clipType?clipper.clipImage(d.imageUrl,a):"custom"===d.clipType&&clipper.clipCustom(a,b)}function g(){"custom"===d.clipType&&Browser.sendToExtension({name:"setPersistentValueForCurrentUser",key:b.getCustomFormatSiteName(b.isCustomFormat().id)+"UncheckedSections",value:c.getCustomElementUncheckedSections()})}f({notClipping:!1});var h=d.title;"string"!=typeof h&&(h=b.getTitle()),h=a.removeControlCharacters(h).trim(),h||(h=Browser.i18n.getMessage("quickNote_untitledNote"));var i=b.getUrl(),j=null;d.contextMenu&&(j=b.getRecommendationText(!1)),clipResultCoordinator.showClipResult(Z,h,i,j,function(){g(),e(function(a){var b={name:"submitNote",title:h,notebook:d.notebook,tags:d.tags,comment:d.comment,clipType:d.clipType,url:i,userSelectedNotebook:d.userSelectedNotebook,pendingNoteKey:Z,smartFilingNotebookAvailable:d.smartFilingNotebookAvailable,changedSmartFilingNotebook:d.changedSmartFilingNotebook};"screenshot"===d.clipType?d.screenshotUrl?b.content='<img src="'+d.screenshotUrl+'"></img>':(b.content='<img src="resource:0"></img>',b.resources=[a]):b.content=a,Browser.sendToExtension(b),c.reset()},function(a){Browser.sendToExtension({name:"submitNote",clipType:d.clipType,error:a.stack,pendingNoteKey:Z,smartFilingNotebookAvailable:d.smartFilingNotebookAvailable,changedSmartFilingNotebook:d.changedSmartFilingNotebook}),c.reset()})})}function M(a){V.classList.contains("evernoteClipperVisible")&&!document.documentElement.classList.contains("skitchReady")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_useClipType",clipType:a}})}function N(a,b){document.documentElement.classList.contains("skitchReady")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_useSkitchTool",tool:a,subtool:b}})}function O(a,b){b&&(["INPUT","TEXTAREA"].indexOf(b.nodeName)>-1||"true"===b.contentEditable)||Browser.sendToExtension({name:"toggleClipper"},function(){alert("The Clipper couldn't start on this page. Reload the page and try again. If that doesn't help, contact customer support.")})}function P(){return 2===ea}function Q(a){($!==a.bizUser||_!==a.bizComplete)&&(Browser.sendToExtension({name:"bounce",message:{name:"gt_updateUser",ssoRequired:a.bizUser&&!a.bizComplete}}),Browser.sendToExtension({name:"getSmartFilingInfo",recText:b.getRecommendationText(!1),pendingNoteKey:Z,url:b.getUrl()}),$=a.bizUser,_=a.bizComplete)}function R(a){Y.updateSelectedElementsColor(a.color),Y.useColor(a.color),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"color",label:a.color})}function S(a){Y.useTool(a.tool),"crop"===a.tool?(V.style.setProperty("display","none","important"),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"crop"})):"text"===a.tool&&a.loc&&a.charCode&&Y.startActiveTool(a.loc,{value:String.fromCharCode(a.charCode),selectOnFocus:!1})}function T(){Y.zoom(1.1,{x:window.innerWidth/2,y:window.innerHeight/2}),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"zoom_in"})}function U(){Y.zoom(1/1.1,{x:window.innerWidth/2,y:window.innerHeight/2}),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"zoom_out"})}var V,W,X,Y,Z,$,_,aa=!0,ba={},ca={},da={},ea=0,fa=[];this.msgHandlerToggleCoordinator=u,Browser.addMessageHandlers({closeClipper:f,duplicateKeyboardShortcut:g,goToSkitchWaitingMode:h,hideOptions:n,isExtensionOpen:q,receiveKeyboardShortcuts:r,receiveKeyboardShortcutsEnabled:s,receiveScreenshot:t,setGlobalToolsHeight:F,setOptionsHeight:G,showOptions:J,showSSOProgressTooltip:K,startSubmission:L,toggleCoordinator:u,updateKeyboardShortcut:v,updateUserTier:Q,skitch_useColor:R,skitch_useTool:S,skitch_zoomIn:T,skitch_zoomOut:U}),o(),Browser.sendToExtension({name:"coordinatorLoaded"})});